- name: Get System-EFS
  shell: "aws efs describe-file-systems --region={{ placement.region }} --creation-token=system_FHC --query \"FileSystems[0].FileSystemId\" --output=text"
  register: system_efs
  changed_when: false

- name: Get System-EFS Access Points
  shell: "aws efs describe-access-points --region={{ placement.region }} --file-system-id={{ system_efs.stdout }}"
  register: efs_access_points
  changed_when: false

- name: Set Access Points Variable
  set_fact:
    access_points: "{{ efs_access_points.stdout }}"

- name: Create /sapmnt directory
  file:
    path: /sapmnt
    state: directory
    mode: '0755'

- name: Create /usr/sap/trans directory
  file:
    path: /usr/sap/trans
    state: directory
    mode: '0755'

- name: Mount /sapmnt
  mount:
    src: "{{ system_efs.stdout }}.efs.{{ placement.region }}.amazonaws.com:/"
    path: /sapmnt
    opts: "nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport"
    state: mounted
    fstype: nfs4

- name: Mount /usr/sap/trans
  mount:
    src: "{{ system_efs.stdout }}.efs.{{ placement.region }}.amazonaws.com:/"
    path: /usr/sap/trans
    opts: "nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport"
    state: mounted
    fstype: nfs4

